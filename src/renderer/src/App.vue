<script setup lang="ts">
import { PrimaryButton } from '@solidtime/ui'
import { Cog6ToothIcon } from '@heroicons/vue/16/solid'

declare global {
    interface Window {
        getTimezoneSetting: () => string
        getWeekStartSetting: () => string
        __TAURI__: Record<string, unknown>
    }

    // temporary fix for ts import error in notification.ts
    let route: any
}

import { onMounted, ref, watchEffect } from 'vue'
import { initializeAuth, isLoggedIn, openLoginWindow } from './utils/oauth.ts'

import MainTimeEntryTable from './components/MainTimeEntryTable.vue'
import InstanceSettingsModal from './components/InstanceSettingsModal.vue'
import { hideMiniWindow, showMiniWindow } from './utils/window.ts'
import { isWidgetActivated } from './utils/widget.ts'
import OrganizationSwitcher from './components/OrganizationSwitcher.vue'
import SettingsModal from './components/SettingsModal.vue'

import UpdateStatusBar from './components/UpdateStatusBar.vue'

onMounted(() => {
    window.getTimezoneSetting = () => 'Europe/Vienna'
    window.getWeekStartSetting = () => 'monday'

    initializeAuth()
})

watchEffect(async () => {
    if (isLoggedIn.value && isWidgetActivated.value) {
        showMiniWindow()
    } else {
        hideMiniWindow()
    }
})

const showSettingsModal = ref(false)
const showInstanceSettingsModal = ref(false)

import { VueQueryDevtools } from '@tanstack/vue-query-devtools'
import AutoUpdaterOverlay from './components/AutoUpdaterOverlay.vue'
</script>

<template>
    <VueQueryDevtools></VueQueryDevtools>
    <AutoUpdaterOverlay></AutoUpdaterOverlay>

    <div class="h-10 w-full border-b border-border-primary flex justify-end items-center pr-3">
        <div class="flex-1 h-full" style="-webkit-app-region: drag"></div>
        <div v-if="isLoggedIn" class="flex items-center space-x-2">
            <UpdateStatusBar></UpdateStatusBar>
            <OrganizationSwitcher></OrganizationSwitcher>
            <button @click="showSettingsModal = true">
                <Cog6ToothIcon
                    class="w-5 cursor-pointer text-muted opacity-50 hover:opacity-100"></Cog6ToothIcon>
            </button>
            <SettingsModal
                :show="showSettingsModal"
                @close="showSettingsModal = false"></SettingsModal>
        </div>
    </div>
    <MainTimeEntryTable v-if="isLoggedIn" />
    <div v-else>
        <div class="flex flex-col space-y-6 py-12 items-center justify-center">
            <svg class="w-48" viewBox="0 0 384 68" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M21.093 67.246C18.423 67.246 15.7827 66.89 13.172 66.178C10.6207 65.466 8.21767 64.5167 5.963 63.33C3.76767 62.084 1.89867 60.66 0.356 59.058L8.811 50.425C10.235 51.9083 11.926 53.0653 13.884 53.896C15.9013 54.7267 18.0373 55.142 20.292 55.142C21.5973 55.142 22.5763 54.964 23.229 54.608C23.941 54.252 24.297 53.7477 24.297 53.095C24.297 52.1457 23.7927 51.4337 22.784 50.959C21.8347 50.425 20.559 49.98 18.957 49.624C17.4143 49.2087 15.7827 48.734 14.062 48.2C12.3413 47.6067 10.68 46.8353 9.078 45.886C7.476 44.9367 6.17067 43.6017 5.162 41.881C4.21267 40.1603 3.738 37.965 3.738 35.295C3.738 32.5063 4.47967 30.0737 5.963 27.997C7.50567 25.861 9.64167 24.1997 12.371 23.013C15.1003 21.767 18.3043 21.144 21.983 21.144C25.721 21.144 29.281 21.7967 32.663 23.102C36.045 24.348 38.7743 26.2467 40.851 28.798L32.307 37.431C30.883 35.829 29.3107 34.7313 27.59 34.138C25.8693 33.4853 24.297 33.159 22.873 33.159C21.5083 33.159 20.5293 33.3667 19.936 33.782C19.3427 34.138 19.046 34.6423 19.046 35.295C19.046 36.0663 19.5207 36.6893 20.47 37.164C21.4787 37.6387 22.7543 38.0837 24.297 38.499C25.899 38.855 27.5307 39.3297 29.192 39.923C30.9127 40.5163 32.5443 41.347 34.087 42.415C35.689 43.4237 36.9647 44.7883 37.914 46.509C38.9227 48.2297 39.427 50.4547 39.427 53.184C39.427 57.5153 37.7657 60.9567 34.443 63.508C31.1203 66 26.6703 67.246 21.093 67.246ZM67.8806 66.979C63.1932 66.979 59.0102 66 55.3316 64.042C51.7122 62.0247 48.8346 59.2953 46.6986 55.854C44.5626 52.3533 43.4946 48.4373 43.4946 44.106C43.4946 39.7747 44.5329 35.918 46.6096 32.536C48.7456 29.0947 51.6529 26.395 55.3316 24.437C59.0102 22.4197 63.1636 21.411 67.7916 21.411C72.4196 21.411 76.5432 22.4197 80.1626 24.437C83.8412 26.395 86.7486 29.0947 88.8846 32.536C91.0206 35.918 92.0886 39.7747 92.0886 44.106C92.0886 48.4373 91.0206 52.3533 88.8846 55.854C86.8079 59.2953 83.9302 62.0247 80.2516 64.042C76.6322 66 72.5086 66.979 67.8806 66.979ZM67.7916 53.184C69.5122 53.184 70.9956 52.828 72.2416 52.116C73.5469 51.3447 74.5556 50.2767 75.2676 48.912C75.9796 47.5473 76.3356 45.975 76.3356 44.195C76.3356 42.415 75.9499 40.8723 75.1786 39.567C74.4666 38.2023 73.4876 37.164 72.2416 36.452C70.9956 35.6807 69.5122 35.295 67.7916 35.295C66.1302 35.295 64.6469 35.6807 63.3416 36.452C62.0362 37.2233 61.0276 38.2913 60.3156 39.656C59.6036 40.9613 59.2476 42.504 59.2476 44.284C59.2476 46.0047 59.6036 47.5473 60.3156 48.912C61.0276 50.2767 62.0362 51.3447 63.3416 52.116C64.6469 52.828 66.1302 53.184 67.7916 53.184ZM98.2324 66V1.119H113.718V66H98.2324ZM122.74 66V22.479H138.315V66H122.74ZM130.483 17.406C128.169 17.406 126.241 16.6347 124.698 15.092C123.155 13.49 122.384 11.5023 122.384 9.12899C122.384 6.815 123.155 4.857 124.698 3.255C126.241 1.653 128.169 0.851995 130.483 0.851995C132.916 0.851995 134.874 1.653 136.357 3.255C137.9 4.857 138.671 6.815 138.671 9.12899C138.671 11.5023 137.9 13.49 136.357 15.092C134.874 16.6347 132.916 17.406 130.483 17.406ZM166.029 66.89C161.816 66.89 158.108 65.911 154.904 63.953C151.7 61.995 149.178 59.325 147.339 55.943C145.559 52.5017 144.669 48.6153 144.669 44.284C144.669 39.8933 145.559 35.9773 147.339 32.536C149.178 29.0947 151.67 26.4247 154.815 24.526C158.019 22.568 161.757 21.589 166.029 21.589C168.758 21.589 171.309 22.0933 173.683 23.102C176.056 24.0513 178.044 25.416 179.646 27.196C181.248 28.976 182.197 30.9933 182.494 33.248V54.519C182.197 56.7737 181.248 58.8503 179.646 60.749C178.044 62.6477 176.056 64.1607 173.683 65.288C171.309 66.356 168.758 66.89 166.029 66.89ZM168.788 53.095C170.508 53.095 171.992 52.739 173.238 52.027C174.484 51.2557 175.463 50.2173 176.175 48.912C176.946 47.5473 177.332 45.975 177.332 44.195C177.332 42.4743 176.976 40.9613 176.264 39.656C175.552 38.3507 174.543 37.3123 173.238 36.541C171.992 35.7697 170.538 35.384 168.877 35.384C167.215 35.384 165.732 35.7697 164.427 36.541C163.181 37.3123 162.172 38.3803 161.401 39.745C160.689 41.0503 160.333 42.5337 160.333 44.195C160.333 45.9157 160.689 47.4583 161.401 48.823C162.113 50.1283 163.121 51.1667 164.427 51.938C165.732 52.7093 167.186 53.095 168.788 53.095ZM191.928 66H176.709V54.341L178.934 43.661L176.442 33.159V1.119H191.928V66ZM206.928 66V4.501H222.414V66H206.928ZM197.316 35.384V22.479H232.026V35.384H197.316ZM237.38 66V22.479H252.955V66H237.38ZM245.123 17.406C242.809 17.406 240.88 16.6347 239.338 15.092C237.795 13.49 237.024 11.5023 237.024 9.12899C237.024 6.815 237.795 4.857 239.338 3.255C240.88 1.653 242.809 0.851995 245.123 0.851995C247.555 0.851995 249.513 1.653 250.997 3.255C252.539 4.857 253.311 6.815 253.311 9.12899C253.311 11.5023 252.539 13.49 250.997 15.092C249.513 16.6347 247.555 17.406 245.123 17.406ZM261.978 66V22.479H277.464V66H261.978ZM289.301 66V40.813C289.301 38.9737 288.738 37.5497 287.61 36.541C286.483 35.473 285.089 34.939 283.427 34.939C282.241 34.939 281.202 35.1763 280.312 35.651C279.422 36.1257 278.71 36.808 278.176 37.698C277.702 38.5287 277.464 39.567 277.464 40.813L271.412 38.41C271.412 34.9093 272.184 31.913 273.726 29.421C275.269 26.929 277.346 25.0007 279.956 23.636C282.567 22.2713 285.534 21.589 288.856 21.589C291.823 21.589 294.493 22.301 296.866 23.725C299.299 25.0897 301.227 27.018 302.651 29.51C304.075 32.002 304.787 34.939 304.787 38.321V66H289.301ZM316.624 66V40.813C316.624 38.9737 316.061 37.5497 314.933 36.541C313.806 35.473 312.412 34.939 310.75 34.939C309.623 34.939 308.585 35.1763 307.635 35.651C306.745 36.1257 306.033 36.808 305.499 37.698C305.025 38.5287 304.787 39.567 304.787 40.813L295.709 40.368C295.828 36.452 296.688 33.0997 298.29 30.311C299.892 27.5223 302.088 25.3863 304.876 23.903C307.724 22.3603 310.928 21.589 314.488 21.589C317.87 21.589 320.896 22.301 323.566 23.725C326.236 25.149 328.313 27.2257 329.796 29.955C331.339 32.625 332.11 35.829 332.11 39.567V66H316.624ZM362.184 66.979C357.319 66.979 353.017 66.0297 349.279 64.131C345.541 62.173 342.604 59.4733 340.468 56.032C338.332 52.5907 337.264 48.645 337.264 44.195C337.264 39.8043 338.302 35.918 340.379 32.536C342.456 29.0947 345.274 26.395 348.834 24.437C352.453 22.4197 356.518 21.411 361.027 21.411C365.418 21.411 369.304 22.3603 372.686 24.259C376.127 26.0983 378.797 28.6793 380.696 32.002C382.654 35.2653 383.633 39.0033 383.633 43.216C383.633 44.106 383.574 45.0257 383.455 45.975C383.396 46.865 383.218 47.9033 382.921 49.09L344.562 49.268V39.3L376.78 39.033L369.838 43.394C369.779 40.9613 369.423 38.9737 368.77 37.431C368.117 35.829 367.168 34.6127 365.922 33.782C364.676 32.9513 363.104 32.536 361.205 32.536C359.247 32.536 357.556 33.0107 356.132 33.96C354.708 34.9093 353.61 36.2443 352.839 37.965C352.068 39.6857 351.682 41.7623 351.682 44.195C351.682 46.687 352.097 48.823 352.928 50.603C353.759 52.3237 354.945 53.629 356.488 54.519C358.031 55.409 359.929 55.854 362.184 55.854C364.32 55.854 366.189 55.498 367.791 54.786C369.452 54.074 370.936 52.9763 372.241 51.493L380.34 59.592C378.204 62.0247 375.593 63.864 372.508 65.11C369.482 66.356 366.041 66.979 362.184 66.979Z"
                    fill="white" />
            </svg>
            <p class="text-center text-muted max-w-sm">
                Welcome to the solidtime desktop client. Sign in with your solidtime account to get
                started.
            </p>
            <PrimaryButton @click="openLoginWindow()">Log in with solidtime</PrimaryButton>
            <button
                class="flex items-center text-muted space-x-1 text-sm font-semibold opacity-50"
                @click="showInstanceSettingsModal = true">
                <Cog6ToothIcon class="w-4"></Cog6ToothIcon>
                <span> Instance Settings </span>
            </button>
            <InstanceSettingsModal
                :show="showInstanceSettingsModal"
                @close="showInstanceSettingsModal = false"></InstanceSettingsModal>
        </div>
    </div>
</template>

<style scoped></style>
